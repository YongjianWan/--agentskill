# 会话状态文件
# AI 助手在每轮会话结束时更新此文件
# 新会话开始时首先读取此文件

meta:
  project: "meeting-management"
  version: "1.0-beta"
  updated: "2026-02-26"
  session_count: 9

# === 系统状态 ===
system:
  phase: "re-architecture"
  # re-architecture: 架构重构期（抛弃Handy，浏览器直连自建转写后端）
  # stabilization: 功能基本可用，进入稳定化阶段
  # architecture-revision: 架构重构期（从 Skill 升级为功能模块）
  # day-N: 功能开发阶段
  # maintenance: 维护阶段

  key_decisions:
    - "【架构定位】灵犀'帮我听'声音模块，后端独立服务"
    - "【职责边界】只负责后端，前端按API接入"
    - "【处理原则】服务器处理（转写/理解/存储）"
    - "【通信方式】REST API + WebSocket"
    - "【AI 角色】AI处理语义、生成纪要"
    - "【演进路线】V1.0 基础闭环 → V1.5 实时增强 → V2.0 智能沉淀"
    - "【架构调整-2026-02-25】浏览器直连后端，Handy转备选方案"
    - "【架构重构-2026-02-26】抛弃Handy，自建转写后端（浏览器MediaRecorder → 后端Whisper）"

# === 当前任务 ===
tasks:
  active:
    - id: "WS-001"
      desc: "【WebSocket】改造协议为start/chunk/end，对接音频流处理"
      status: "in_progress"
      start: "2026-02-26"
      
  next:
    - id: "DB-001"
      desc: "【数据库】扩展表结构支持音频流存储"
      status: "pending"
      subtasks:
        - "meetings表新增：audio_path, minutes_path, status"
        - "新增transcripts表：sequence, text, timestamp"
        - "新增topics表：title, conclusion"
        - "新增action_items表：content, assignee, due_date, status"
      note: "SQLite先用，保持SQLAlchemy兼容瀚高"
      
    - id: "SKILL-001"
      desc: "【meeting_skill】新增音频流处理方法"
      status: "completed"
      done: "2026-02-26"
      subtasks:
        - "MeetingSessionManager类：管理音频文件句柄"
        - "transcribe_bytes(audio_bytes)：直接转写bytes"
        - "generate_minutes_after_meeting(meeting_id)：会后全量生成纪要"
      note: "转写触发策略：按时间30秒一次"
      
    - id: "WS-001"
      desc: "【WebSocket】简化协议，直接接收音频块"
      status: "pending"
      subtasks:
        - "消息协议简化：start/chunk/end"
        - "start：创建meeting，初始化audio.webm"
        - "chunk：追加写入，每30秒触发转写"
        - "end：关闭文件，全量转写剩余，生成纪要，导出Word"
      note: "删除旧Handy相关代码"
      
    - id: "TEST-001"
      desc: "【测试】端到端音频流测试"
      status: "pending"
      subtasks:
        - "Python模拟客户端发送音频块"
        - "验证全链路：上传→转写→存库→生成纪要→导出Word"
      note: "测试脚本用mock音频数据"
      
    - id: "CLEAN-001"
      desc: "【清理】删除旧Handy相关代码"
      status: "pending"
      subtasks:
        - "删除scripts/websocket_server.py（旧Handy版）"
        - "删除scripts/websocket_server_v2.py"
        - "删除Handy相关测试脚本"
      note: "旧代码就是负债，直接删不留legacy"

  completed:
    - id: "BACKEND-001"
      desc: "【后端开发】Phase 1: REST API骨架"
      done: "2026-02-25"
      subtasks:
        - "✅ REST API 骨架：会议CRUD（POST/GET /meetings）"
        - "✅ 文件上传接口：POST /upload/audio"
        - "✅ 数据库持久化：SQLAlchemy模型（SQLite+瀚高HighGoDB双支持）"
        - "✅ 历史查询接口：GET /meetings 列表查询"
      deliverable: "FastAPI框架 + REST API + 数据库模型"

    - id: "BACKEND-002"
      desc: "【后端开发】Phase 2: WebSocket + 实时转写"
      done: "2026-02-25"
      subtasks:
        - "✅ WebSocket服务：音频流接收（/ws/meeting/{id}）"
        - "✅ 音频缓存合并：片段缓存→合并→转写"
        - "✅ Mock实时转写：模拟Whisper逐段转写"
        - "✅ 实时字幕推送：transcript下行消息"
        - "✅ 转写文本编辑：支持前端编辑后保存"
      deliverable: "WebSocket实时音频流 + 实时字幕推送"
      
    - id: "STABLE-001"
      desc: "稳定化现有功能，修复潜在 bug"
      done: "2026-02-25"
      notes: |
        完成内容:
        1. AI 生成: 添加重试机制(3次)、可配置超时、文本截断、详细日志
        2. WebSocket: 会话超时清理(60分钟)、消息大小限制(1MB)、详细连接日志
        3. 日志系统: 统一日志配置(logger_config.py)、文件日志、错误分离
        4. 边界处理: 磁盘空间检查、安全文件写入、内存检查、文本验证
        新增文件: src/logger_config.py, src/utils.py
      deliverable: "AI 纪要生成功能稳定可用"

# === 重构决策记录 ===
rearchitecture:
  trigger: "抛弃Handy，浏览器MediaRecorder直连后端"
  date: "2026-02-26"
  
  changes:
    - area: "输入源"
      before: "Handy长连接 → websocket_server.py"
      after: "浏览器MediaRecorder → 后端WebSocket"
      
    - area: "接收数据"
      before: "接收Handy转写后的文字"
      after: "接收音频块(bytes)，后端自己转写"
      
    - area: "转写触发"
      before: "Handy触发，后端被动接收"
      after: "后端每30秒触发一次Whisper转写"
      
    - area: "纪要生成"
      before: "原有逻辑"
      after: "会议结束后全量生成（非实时增量）"
      
    - area: "文件存储"
      before: "JSON存储转写结果"
      after: "audio.webm + transcripts表 + minutes.docx"
      
  constraints:
    - "音频格式：直接存webm，转写时用临时文件给whisper"
    - "不做实时转码，够用就行"
    - "不分chunks/目录，调试看日志"
    - "旧代码直接删，不留legacy"
    
  todo_next:
    - "数据库扩展：新增transcripts/topics/action_items表"
    - "meeting_skill新增：MeetingSessionManager + transcribe_bytes"
    - "WebSocket改造：简化协议为start/chunk/end"
    - "端到端测试：Python模拟音频流客户端"
    - "删除旧代码：Handy相关脚本全删"

# === 已知问题 ===
issues:
  open: []
  closed: []

# === 待决策项 ===
decisions_pending: []

# === 快速参考 ===
quickref:
  dev_spec: "docs/SKILL.md"
  protocol: "docs/DOCUMENT_PROTOCOL.md"
  project_context: "PROJECT_CONTEXT.md"
  tech_stack:
    core: "Python 3.11+"
    backend: "FastAPI + SQLAlchemy(async)"
    database: "SQLite(开发) + 瀚高HighGoDB(生产)"
    transcription: "faster-whisper (small model)"
    document: "python-docx"
    websocket: "FastAPI WebSocket"
  test_dir: "test/"

# === 首读流程 ===
reading_order:
  - file: PROJECT_CONTEXT.md
    status: prerequisite
    purpose: "项目概况（必读）"

  - file: SESSION_STATE.yaml
    status: current
    purpose: "任务状态（本文件）"

  - file: docs/SKILL.md
    status: on_demand
    purpose: "完整开发规格（实现时按需读对应章节）"

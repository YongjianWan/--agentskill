# 会话状态文件
# AI 助手在每轮会话结束时更新此文件
# 新会话开始时首先读取此文件

meta:
  project: "meeting-management"
  version: "1.1-beta"
  updated: "2026-02-26"
  session_count: 10
  last_session_summary: |
    本轮完成：
    1. DB-001: 数据库扩展完成（新增transcripts/action_items表，扩展MeetingModel）
    2. SKILL-001: 流式处理方法完成（init_meeting_session/append_audio_chunk/finalize_meeting）
    3. WS-001: WebSocket协议改造完成（start/chunk/end新协议）
    4. TEST-001: 单元测试完成（test_audio_stream.py全通过）
    5. 添加VS Code配置和Pyright类型检查配置

# === 系统状态 ===
system:
  phase: "re-architecture"
  # re-architecture: 架构重构期（抛弃Handy，浏览器直连自建转写后端）

  key_decisions:
    - "【架构定位】灵犀'帮我听'声音模块，后端独立服务"
    - "【职责边界】只负责后端，前端按API接入"
    - "【处理原则】服务器处理（转写/理解/存储）"
    - "【通信方式】REST API + WebSocket"
    - "【AI 角色】AI处理语义、生成纪要"
    - "【演进路线】V1.0 基础闭环 → V1.5 实时增强 → V2.0 智能沉淀"
    - "【架构调整-2026-02-25】浏览器直连后端，Handy转备选方案"
    - "【架构重构-2026-02-26】抛弃Handy，自建转写后端（浏览器MediaRecorder → 后端Whisper）"

# === 当前任务 ===
tasks:
  active:
    - id: "TEST-002"
      desc: "【端到端测试】WebSocket全链路测试"
      status: "in_progress"
      start: "2026-02-26"
      steps:
        - "启动服务: cd src && uvicorn main:app --reload --port 8765"
        - "运行测试: python test/test_websocket_new_protocol.py"
        - "验证: start → chunk → end 全链路通"
      note: "测试脚本已写好，需要启动服务后运行"
      
  completed:
    - id: "WS-001"
      desc: "【WebSocket】改造协议为start/chunk/end"
      status: "completed"
      done: "2026-02-26"
      files:
        - "src/api/websocket.py (重写)"
        - "src/services/websocket_manager.py (新增send_custom_message)"
      protocol:
        - "上行: start/chunk/end"
        - "下行: started/transcript/completed/error"
      
    - id: "SKILL-001"
      desc: "【meeting_skill】新增流式处理方法"
      status: "completed"
      done: "2026-02-26"
      methods:
        - "init_meeting_session() - 初始化会议+创建audio.webm"
        - "append_audio_chunk() - 追加音频+30秒触发转写"
        - "finalize_meeting() - 结束会议+生成纪要+导出Word"
        - "transcribe_bytes() - 直接转写bytes"
      test: "test/test_audio_stream.py 通过"
      
    - id: "DB-001"
      desc: "【数据库】扩展表结构"
      status: "completed"
      done: "2026-02-26"
      changes:
        - "MeetingModel: +minutes_docx_path, +audio_chunks_received"
        - "新增 TranscriptModel 表"
        - "新增 ActionItemModel 表"
      
    - id: "TEST-001"
      desc: "【单元测试】meeting_skill流式处理"
      status: "completed"
      done: "2026-02-26"
      coverage:
        - "init/append/finalize全链路"
        - "30秒触发逻辑"
        - "错误处理"
      
  next:
    - id: "CLEAN-001"
      desc: "【清理】删除旧Handy相关代码"
      status: "pending"
      targets:
        - "scripts/websocket_server.py（旧Handy版）"
        - "scripts/websocket_server_v2.py"
        - "Handy相关测试脚本"
      note: "旧代码就是负债，直接删不留legacy"

# === 新会话必读 ===
new_session_guide:
  read_first:
    - "PROJECT_CONTEXT.md - 项目概况和架构"
    - "本文件(SESSION_STATE.yaml) - 当前任务状态"
    
  current_status: |
    架构重构基本完成，核心功能已就绪：
    - 数据库: 表结构已扩展，支持音频流存储
    - meeting_skill: 流式处理方法已实现并测试通过
    - WebSocket: 新协议(start/chunk/end)已实现
    
    下一步是端到端测试，验证全链路是否通畅。
    
  important_notes:
    - "Pylance类型警告: SQLAlchemy Column相关警告是预期的，不影响运行"
    - "类型检查模式: 已设为basic，误报已最小化"
    - "测试: 先运行test_audio_stream.py确认单元测试通过，再跑WebSocket端到端"
    
  quick_commands:
    - "启动服务: cd src && uvicorn main:app --reload --port 8765"
    - "单元测试: python test/test_audio_stream.py"
    - "WebSocket测试: python test/test_websocket_new_protocol.py"
    - "API文档: http://localhost:8765/docs"

# === 重构决策记录 ===
rearchitecture:
  trigger: "抛弃Handy，浏览器MediaRecorder直连后端"
  date: "2026-02-26"
  
  changes:
    - area: "输入源"
      before: "Handy长连接 → websocket_server.py"
      after: "浏览器MediaRecorder → 后端WebSocket"
      
    - area: "接收数据"
      before: "接收Handy转写后的文字"
      after: "接收音频块(bytes)，后端自己转写"
      
    - area: "转写触发"
      before: "Handy触发，后端被动接收"
      after: "后端每30秒触发一次Whisper转写"
      
    - area: "纪要生成"
      before: "原有逻辑"
      after: "会议结束后全量生成（非实时增量）"
      
    - area: "文件存储"
      before: "JSON存储转写结果"
      after: "audio.webm + transcripts表 + minutes.docx"
      
  constraints:
    - "音频格式：直接存webm，转写时用临时文件给whisper"
    - "不做实时转码，够用就行"
    - "不分chunks/目录，调试看日志"
    - "旧代码直接删，不留legacy"

# === 已知问题 ===
issues:
  open:
    - id: "PYLANCE-001"
      desc: "Pylance对SQLAlchemy Column类型推断不完全准确"
      severity: "low"
      impact: "仅类型检查，不影响运行时"
      workaround: "已配置为basic模式，误报最小化"
      
  closed: []

# === 快速参考 ===
quickref:
  dev_spec: "docs/SKILL.md"
  protocol: "docs/DOCUMENT_PROTOCOL.md"
  project_context: "PROJECT_CONTEXT.md"
  tech_stack:
    core: "Python 3.11+"
    backend: "FastAPI + SQLAlchemy(async)"
    database: "SQLite(开发) + 瀚高HighGoDB(生产)"
    transcription: "faster-whisper (small model)"
    document: "python-docx"
    websocket: "FastAPI WebSocket"
  test_dir: "test/"
  key_files:
    - "src/meeting_skill.py - 核心Skill实现"
    - "src/api/websocket.py - WebSocket处理"
    - "src/models/meeting.py - 数据模型"
    - "src/services/websocket_manager.py - 连接管理"

# === 首读流程 ===
reading_order:
  - file: PROJECT_CONTEXT.md
    status: prerequisite
    purpose: "项目概况（必读）"

  - file: SESSION_STATE.yaml
    status: current
    purpose: "任务状态（本文件）"

  - file: docs/SKILL.md
    status: on_demand
    purpose: "完整开发规格（实现时按需读对应章节）"

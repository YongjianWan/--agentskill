# 未来更新计划（业务流程缺口分析）

> 基于完整业务流程推演，识别当前缺口与未来迭代方向

---

## 零、实际测试发现的问题（2026-02-25）

基于代码审查和实际运行测试，发现以下具体问题：

### 🔴 严重问题

| 问题 | 现状 | 影响 | 优先级 |
|------|------|------|--------|
| **AI 填充缺失** | `generate_minutes()` 返回 `topics=[]` | 会议纪要为空，需人工填充 | P0 |
| **无实时推送** | WebSocket 只接收不推送 | 前端无法显示实时字幕 | P0 |
| **规则引擎失效** | 结论命中率0%，行动项噪音30% | 生成的纪要质量极差（见 test_result.json） | P0 |

### 🟡 功能缺口

| 问题 | 现状 | 需求 |
|------|------|------|
| **无状态管理** | 会议状态在内存中 | 服务重启丢失，需持久化 |
| **无用户隔离** | 只有 session_id | 多人使用冲突，需 user_id |
| **离线生成** | 会后批量处理 | 需增量生成草稿纪要 |
| **单一输入源** | 仅 Handy WebSocket | 需浏览器录音、文件上传 |

### 测试样本问题（test_result.json）

```json
// 实际生成结果示例
{
  "topics": [{
    "title": "[00:00:01] 主持人：大家早上好...",  // ❌ 标题是原文截取
    "conclusion": "",  // ❌ 结论为空
    "action_items": [
      {"action": "我在，前端开发负责人张三。", ...},  // ❌ 把自我介绍当行动项
      {"action": "目前前端完成了80%...", ...}  // ❌ 把进度汇报当行动项
    ]
  }]
}
```

**根本原因**：`_extract_topics_with_conclusion()` 等规则引擎函数已弃用，但无替代方案。

---

## 一、完整业务流程推演

### 场景：用户打开灵犀，点击底部"帮我听"

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          【阶段一：启动会议】                             │
└─────────────────────────────────────────────────────────────────────────┘

用户：点击"帮我听"按钮
  ↓
灵犀前端：调用后端 "创建会议会话" API
  ↓
声音模块：
  - 生成会议 ID
  - 初始化 WebSocket 房间
  - 返回：会议ID + WebSocket地址 + 临时Token
  ↓
灵犀前端：建立 WebSocket 连接（长连接）
  ↓
用户：看到"正在录音..."界面，开始说话
```

**缺口识别 #1：会话管理**
- 当前：无会议状态管理（谁在开会、开了多久）
- 需要：会议状态机（准备中→录音中→处理中→已完成）

**缺口识别 #2：权限控制**
- 当前：本地文件存储，无用户隔离
- 需要：用户身份识别（会议归属哪个灵犀用户）

---

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          【阶段二：实时录音】                             │
└─────────────────────────────────────────────────────────────────────────┘

用户：说话（音频流）
  ↓
音频输入源：
  ├─ 方案A：Handy 桌面端捕获 → WebSocket 发送
  ├─ 方案B：浏览器 WebRTC 捕获 → WebSocket 发送  ← 缺口
  └─ 方案C：App 原生录音 → 上传/流式发送        ← 缺口
  ↓
声音模块（服务器）：
  - 接收音频流
  - 分段转写（Whisper）
  - 实时推送转写结果 → 灵犀前端
  ↓
灵犀前端：实时显示字幕
  ↓
AI（灵犀智能体）：
  - 监听转写流（可选）
  - 实时提取议题/结论/行动项
  - 推送结构化标记 → 灵犀前端
  ↓
灵犀前端：实时高亮"议题开始"、"已识别行动项"
```

**缺口识别 #3：音频输入源多样化**
- 当前：仅 Handy（桌面端）
- 需要：浏览器录音、App原生录音支持

**缺口识别 #4：实时语义理解**
- 当前：会后一次性处理
- 需要：流式 AI 处理（增量分析）

**缺口识别 #5：断线恢复**
- 当前：无重连机制
- 需要：WebSocket 断线重连 + 录音续传

---

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          【阶段三：结束会议】                             │
└─────────────────────────────────────────────────────────────────────────┘

用户：点击"结束录音"
  ↓
灵犀前端：发送"停止录音"指令
  ↓
声音模块：
  - 关闭音频接收
  - 标记会议状态为"处理中"
  - 触发 AI 生成完整纪要
  ↓
AI：
  - 读取完整转写文本
  - 生成结构化会议纪要（议题/结论/行动项）
  - 返回结构化数据
  ↓
声音模块：
  - 保存 JSON（结构化数据）
  - 生成 DOCX（Word文档）
  - 更新会议状态为"已完成"
  ↓
灵犀前端：展示会议纪要 + 下载按钮
```

**缺口识别 #6：AI 降级策略**
- 当前：依赖 AI 生成纪要
- 需要：AI 异常时，返回原始转写 + 提示

**缺口识别 #7：多格式输出**
- 当前：JSON + DOCX
- 需要：Markdown（灵犀知识库）、PDF、飞书文档

---

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          【阶段四：历史查询】                             │
└─────────────────────────────────────────────────────────────────────────┘

用户：问"上周开了几次会？"
  ↓
灵犀智能体：
  - 解析意图：统计查询 + 时间范围
  - 调用 count_meetings(date_range)
  ↓
声音模块：
  - SQL查询（SQLite）
  - 返回：会议列表 + 基础统计
  ↓
灵犀智能体：整理为自然语言回答
  ↓
用户：看到"上周开了3次会议，分别是..."
```

**缺口识别 #8：自然语言查询**
- 当前：需明确 API 调用
- 需要：NL2SQL（自然语言转查询）

**缺口识别 #9：知识库集成**
- 当前：独立存储
- 需要：会议纪要自动同步到"帮我存"知识库

---

## 二、缺口汇总与优先级

| 缺口ID | 描述 | 优先级 | 所属阶段 |
|--------|------|--------|----------|
| #1 | 会议状态管理 | P0 | 启动 |
| #2 | 用户权限隔离 | P0 | 启动 |
| #3 | 浏览器/App录音 | P1 | 实时 |
| #4 | 实时流式AI理解 | P1 | 实时 |
| #5 | WebSocket断线重连 | P0 | 实时 |
| #6 | AI降级策略 | P1 | 结束 |
| #7 | 多格式输出 | P2 | 结束 |
| #8 | 自然语言查询 | P2 | 查询 |
| #9 | 知识库自动同步 | P1 | 查询 |

---

## 三、未来迭代路线图

### V1.0 基础闭环（当前→1个月）
目标：让"帮我听"能完整跑通一次会议

- [ ] 会议状态管理（准备→录音→处理→完成）
- [ ] 用户权限隔离（会议归属）
- [ ] WebSocket 断线重连机制
- [ ] Handy 端到端联调验证
- [ ] SQLite 数据库迁移
- [ ] AI 异常降级（原始转写兜底）

### V1.5 实时增强（1-2个月）
目标：会议进行中就能看到初步结果

- [ ] 实时字幕推送（边说边出字）
- [ ] 流式 AI 理解（增量议题提取）
- [ ] 浏览器录音支持（WebRTC）
- [ ] 会议纪要自动同步知识库

### V2.0 智能沉淀（2-3个月）
目标：从"记录工具"进化为"知识沉淀"

- [ ] 自然语言查询（NL2SQL）
- [ ] 会议统计与洞察（本周/本月/趋势）
- [ ] 跨会议行动项追踪
- [ ] 多格式输出（PDF/飞书/钉钉）

### V3.0 生态扩展（3个月+）
目标：成为企业级会议基础设施

- [ ] 多人协作会议（主持人/参会人权限）
- [ ] 实时翻译（中英双语字幕）
- [ ] 会议摘要自动生成（1分钟读完1小时）
- [ ] 与任务系统深度集成（自动创建任务卡片）

---

## 四、技术债务与架构决策

### 待决策项

| 决策 | 选项 | 影响 |
|------|------|------|
| 音频输入 | Handy only / 浏览器 / App 原生 | 开发成本、用户体验 |
| AI 处理 | 实时流式 / 会后批量 | 成本、延迟、准确率 |
| 存储 | SQLite / PostgreSQL / 云存储 | 扩展性、运维复杂度 |
| 部署 | 本地私有化 / SaaS / 混合 | 数据安全、成本 |

### 技术债务

- [ ] 清理 `_extract_topics_with_conclusion` 弃用代码
- [ ] 统一错误处理与日志规范
- [ ] 补充单元测试与集成测试
- [ ] API 文档自动生成

---

*最后更新：2026-02-25*
*状态：待老大确认架构后细化*
